name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  claude-review:
    name: AI Code Review
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get PR details and diff
      id: pr-info
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Get PR number
        PR_NUMBER=${{ github.event.pull_request.number }}

        # Get PR details
        gh pr view $PR_NUMBER --json title,body,additions,deletions,changedFiles > pr-details.json

        # Get PR diff
        gh pr diff $PR_NUMBER > pr-diff.txt

        # Create a summary
        echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT

    - name: Review with Claude
      id: claude-review
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        # Read PR details and diff
        PR_TITLE=$(jq -r '.title' pr-details.json)
        PR_BODY=$(jq -r '.body // "No description provided"' pr-details.json)
        ADDITIONS=$(jq -r '.additions' pr-details.json)
        DELETIONS=$(jq -r '.deletions' pr-details.json)
        CHANGED_FILES=$(jq -r '.changedFiles' pr-details.json)

        # Build the review prompt
        PROMPT="You are an expert code reviewer for C#, .NET, Blazor, and Avalonia projects. Review this pull request and provide:

        1. **Summary**: Brief overview of changes
        2. **Code Quality**: Assessment of code organization, patterns, and best practices
        3. **Potential Issues**: Security concerns, bugs, performance issues, or breaking changes
        4. **Recommendations**: Suggestions for improvements
        5. **Verdict**: APPROVE, REQUEST CHANGES, or COMMENT

        Be constructive, concise, and focus on important issues. Use markdown formatting.

        ---

        **PR Title**: ${PR_TITLE}

        **Description**: ${PR_BODY}

        **Stats**: +${ADDITIONS} / -${DELETIONS} lines across ${CHANGED_FILES} files

        **Diff**:
        \`\`\`diff
        $(cat pr-diff.txt)
        \`\`\`"

        # Create JSON payload using jq to properly escape everything
        jq -n \
          --arg model "claude-sonnet-4-5-20250929" \
          --arg prompt "$PROMPT" \
          '{
            model: $model,
            max_tokens: 4096,
            messages: [
              {
                role: "user",
                content: $prompt
              }
            ]
          }' > review-request.json

        # Call Claude API
        RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
          -H "x-api-key: $ANTHROPIC_API_KEY" \
          -H "anthropic-version: 2023-06-01" \
          -H "content-type: application/json" \
          -d @review-request.json)

        # Debug: save full response
        echo "$RESPONSE" > claude-response.json

        # Extract the review text
        REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text // "Error: No review generated"')

        # Check if there was an error
        ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')
        if [ ! -z "$ERROR" ]; then
          echo "API Error: $ERROR"
          REVIEW="**Error calling Claude API**: $ERROR"
        fi

        # Save review to file for next step
        echo "$REVIEW" > claude-review.md

        # Also save to output (escaped for GitHub Actions)
        {
          echo 'REVIEW<<EOF'
          echo "$REVIEW"
          echo 'EOF'
        } >> $GITHUB_OUTPUT

    - name: Post review comment
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PR_NUMBER=${{ steps.pr-info.outputs.PR_NUMBER }}

        # Create comment body with header
        cat > comment.md <<'EOF'
        ## ðŸ¤– Claude AI Code Review

        EOF

        # Append the actual review
        cat claude-review.md >> comment.md

        # Add footer
        cat >> comment.md <<'EOF'

        ---
        *Generated by Claude Sonnet 4.5 via GitHub Actions*
        EOF

        # Post comment to PR
        gh pr comment $PR_NUMBER --body-file comment.md

    - name: Upload review artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: claude-review
        path: |
          pr-details.json
          pr-diff.txt
          claude-review.md
          claude-response.json
        retention-days: 30
