name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  claude-review:
    name: AI Code Review
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get PR details and diff
      id: pr-info
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Get PR number
        PR_NUMBER=${{ github.event.pull_request.number }}

        # Get PR details
        gh pr view $PR_NUMBER --json title,body,additions,deletions,changedFiles > pr-details.json

        # Get PR diff
        gh pr diff $PR_NUMBER > pr-diff.txt

        # Create a summary
        echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT

    - name: Review with Claude
      id: claude-review
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        # Read PR details and diff
        PR_TITLE=$(jq -r '.title' pr-details.json)
        PR_BODY=$(jq -r '.body // "No description provided"' pr-details.json)
        ADDITIONS=$(jq -r '.additions' pr-details.json)
        DELETIONS=$(jq -r '.deletions' pr-details.json)
        CHANGED_FILES=$(jq -r '.changedFiles' pr-details.json)
        PR_DIFF=$(cat pr-diff.txt)

        # Create the review prompt
        cat > review-request.json <<EOF
        {
          "model": "claude-sonnet-4-5-20250929",
          "max_tokens": 4096,
          "messages": [
            {
              "role": "user",
              "content": "You are an expert code reviewer for C#, .NET, Blazor, and Avalonia projects. Review this pull request and provide:\n\n1. **Summary**: Brief overview of changes\n2. **Code Quality**: Assessment of code organization, patterns, and best practices\n3. **Potential Issues**: Security concerns, bugs, performance issues, or breaking changes\n4. **Recommendations**: Suggestions for improvements\n5. **Verdict**: APPROVE, REQUEST CHANGES, or COMMENT\n\nBe constructive, concise, and focus on important issues. Use markdown formatting.\n\n---\n\n**PR Title**: ${PR_TITLE}\n\n**Description**: ${PR_BODY}\n\n**Stats**: +${ADDITIONS} / -${DELETIONS} lines across ${CHANGED_FILES} files\n\n**Diff**:\n\`\`\`diff\n${PR_DIFF}\n\`\`\`"
            }
          ]
        }
        EOF

        # Call Claude API
        RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
          -H "x-api-key: $ANTHROPIC_API_KEY" \
          -H "anthropic-version: 2023-06-01" \
          -H "content-type: application/json" \
          -d @review-request.json)

        # Extract the review text
        REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text')

        # Save review to file for next step
        echo "$REVIEW" > claude-review.md

        # Also save to output (escaped for GitHub Actions)
        {
          echo 'REVIEW<<EOF'
          echo "$REVIEW"
          echo 'EOF'
        } >> $GITHUB_OUTPUT

    - name: Post review comment
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PR_NUMBER=${{ steps.pr-info.outputs.PR_NUMBER }}

        # Create comment body with header
        cat > comment.md <<'EOF'
        ## ðŸ¤– Claude AI Code Review

        EOF

        # Append the actual review
        cat claude-review.md >> comment.md

        # Add footer
        cat >> comment.md <<'EOF'

        ---
        *Generated by Claude Sonnet 4.5 via GitHub Actions*
        EOF

        # Post comment to PR
        gh pr comment $PR_NUMBER --body-file comment.md

    - name: Upload review artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: claude-review
        path: |
          pr-details.json
          pr-diff.txt
          claude-review.md
        retention-days: 30
